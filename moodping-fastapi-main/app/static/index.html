<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MoodPing - ì˜¨ë³´ë”©</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <header class="auth-header">
        <span class="auth-status" id="auth-status"></span>
        <a href="/auth/kakao" class="btn-kakao" id="btn-login">ì¹´ì¹´ì˜¤ë¡œ ë¡œê·¸ì¸</a>
        <a href="/auth/logout" class="btn-logout" id="btn-logout" style="display:none;">ë¡œê·¸ì•„ì›ƒ</a>
    </header>
    <div class="container onboarding-container">
        <h1>MoodPing ğŸŒ™</h1>
        <p>ì˜¤ëŠ˜ì˜ ê°ì •ì„ ê¸°ë¡í•˜ê³ <br>AI ë¶„ì„ìœ¼ë¡œ ë§ˆìŒì„ ëŒì•„ë³´ì„¸ìš”.</p>
        <button id="start-btn" class="btn-primary">ê°ì • ê¸°ë¡ ì‹œì‘</button>
    </div>

    <!-- íŒ€ì› ì‹œê°í™”ìš© ë””ë²„ê·¸ ëŒ€ì‹œë³´ë“œ (í•™ìŠµ/í…ŒìŠ¤íŠ¸ ëª©ì ) -->
    <div class="debug-panel">
        <h4>ğŸ›  Debug Dashboard</h4>
        <button class="refresh-btn" onclick="loadDebugData()">ìƒˆë¡œê³ ì¹¨</button>

        <div class="debug-section">
            <div class="label">ğŸ“‹ ìµœê·¼ ê°ì • ê¸°ë¡</div>
            <div id="debug-records">ë¡œë”© ì¤‘...</div>
        </div>

        <div class="debug-section">
            <div class="label">ğŸ“Š í¼ë„ ì§€í‘œ (ì´íƒˆ ì„ê³„ê°’: 10ë¶„)</div>
            <div id="debug-metrics">ë¡œë”© ì¤‘...</div>
        </div>

        <div class="debug-section">
            <div class="label">ğŸ” ë‹¨ê³„ë³„ ì´íƒˆ ë¶„ì„</div>
            <div id="debug-step-funnel">ë¡œë”© ì¤‘...</div>
        </div>
    </div>

    <script src="/js/common.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            if (location.search.includes('error=kakao_not_configured')) {
                alert('ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸: .envì— KAKAO_REST_API_KEYë¥¼ ì„¤ì •í•˜ì„¸ìš”.');
                history.replaceState({}, '', '/');
            }
            await fetchAuthUser();
            const statusEl = document.getElementById('auth-status');
            const loginEl = document.getElementById('btn-login');
            const logoutEl = document.getElementById('btn-logout');
            if (authUser.logged_in) {
                statusEl.textContent = authUser.nickname + 'ë‹˜';
                loginEl.style.display = 'none';
                logoutEl.style.display = 'inline';
            } else {
                statusEl.textContent = '';
                loginEl.style.display = 'inline';
                logoutEl.style.display = 'none';
            }
            logEvent('onboarding_view');

            document.getElementById('start-btn').addEventListener('click', () => {
                logEvent('record_start_click');  // ì „ì†¡ ì‹œë„ (ì‹¤íŒ¨í•´ë„ ë¬´ì‹œ)
                window.location.href = '/record.html';  // ë°”ë¡œ ì´ë™
            });

            loadDebugData();
        });

        async function loadDebugData() {
            await loadRecentRecords();
            await loadMetrics();
        }

        async function loadRecentRecords() {
            const el = document.getElementById('debug-records');
            try {
                const res = await fetch('/api/debug/recent-records');
                const data = await res.json();

                if (data.length === 0) {
                    el.innerHTML = '<span style="color:#6c7086">ê¸°ë¡ ì—†ìŒ</span>';
                    return;
                }

                el.innerHTML = data.map(r => `
                    <div class="debug-record-item">
                        <span class="label">ID:</span> <span class="value">${r.record_id}</span>
                        &nbsp;|&nbsp;
                        <span class="value">${r.emoji || ''}</span>
                        <span class="label"> ê°•ë„:</span> <span class="value">${r.intensity}/10</span>
                        <br>
                        <span class="label">ë©”ëª¨:</span> <span class="value">${r.mood_text || '-'}</span>
                        <br>
                        <span class="label">ë¶„ì„:</span> <span class="value">${r.analysis_text ? r.analysis_text.substring(0, 60) + '...' : 'ì—†ìŒ'}</span>
                        <br>
                        <span style="color:#6c7086;font-size:10px">${r.recorded_at || ''} | ${r.anon_id ? 'anon:' + r.anon_id.substring(0, 8) : 'user:' + (r.user_id || '?')}</span>
                    </div>
                `).join('');
            } catch (e) {
                el.innerHTML = '<span style="color:#f38ba8">API ì—°ê²° ì‹¤íŒ¨: ' + e.message + '</span>';
            }
        }

        async function loadMetrics() {
            const el = document.getElementById('debug-metrics');
            const stepEl = document.getElementById('debug-step-funnel');
            try {
                const res = await fetch('/api/debug/metrics');
                const d = await res.json();
                const rf = d.funnel.record_funnel;
                const af = d.funnel.analysis_funnel;
                const ret = d.retention;

                el.innerHTML = `
                    <div style="margin-bottom:6px">
                        <span class="label">[ê¸°ë¡ í¼ë„]</span><br>
                        ì‹œì‘: <span class="value">${rf.record_start_count}</span>ëª… â†’
                        ì™„ë£Œ: <span class="value">${rf.record_complete_count}</span>ëª… |
                        ì´íƒˆë¥ : <span class="value">${(rf.record_drop_rate * 100).toFixed(1)}%</span> |
                        í‰ê· : <span class="value">${rf.avg_record_duration_minutes}ë¶„</span>
                    </div>
                    <div style="margin-bottom:6px">
                        <span class="label">[ë¶„ì„ í¼ë„]</span><br>
                        ì™„ë£Œ: <span class="value">${af.record_complete_count}</span>ëª… â†’
                        ì¡°íšŒ: <span class="value">${af.analysis_view_count}</span>ëª… |
                        ì´íƒˆë¥ : <span class="value">${(af.analysis_drop_rate * 100).toFixed(1)}%</span> |
                        í‰ê· : <span class="value">${af.avg_analysis_duration_minutes}ë¶„</span>
                    </div>
                    <div>
                        <span class="label">[7ì¼ ë¦¬í…ì…˜]</span><br>
                        ëŒ€ìƒ: <span class="value">${ret.total_users}</span>ëª… |
                        ì¬ë°©ë¬¸: <span class="value">${ret.retained_users}</span>ëª… |
                        ìœ ì§€ìœ¨: <span class="value">${ret.retention_rate_percent}%</span>
                    </div>
                `;

                // ë‹¨ê³„ë³„ ì´íƒˆ ë¶„ì„
                const steps = d.step_funnel || [];
                if (steps.length === 0) {
                    stepEl.innerHTML = '<span style="color:#6c7086">ë°ì´í„° ì—†ìŒ</span>';
                    return;
                }
                const maxSessions = steps[0].sessions || 1;
                stepEl.innerHTML = steps.map((s, i) => {
                    const barWidth = Math.max(2, Math.round((s.sessions / maxSessions) * 100));
                    const dropPct = (s.drop_rate * 100).toFixed(1);
                    const dropColor = s.drop_rate > 0.3 ? '#f38ba8' : s.drop_rate > 0.1 ? '#fab387' : '#a6e3a1';
                    const arrow = i > 0 ? `<span style="color:${dropColor}">â†“ ${dropPct}% ì´íƒˆ</span><br>` : '';
                    return `
                        ${arrow}
                        <div style="margin:3px 0;display:flex;align-items:center;gap:8px">
                            <span style="min-width:80px;font-size:11px">${s.label}</span>
                            <div style="background:#45475a;border-radius:4px;flex:1;height:14px;overflow:hidden">
                                <div style="background:#89b4fa;width:${barWidth}%;height:100%;border-radius:4px"></div>
                            </div>
                            <span class="value" style="min-width:30px;text-align:right">${s.sessions}</span>
                        </div>
                    `;
                }).join('');
            } catch (e) {
                el.innerHTML = '<span style="color:#f38ba8">API ì—°ê²° ì‹¤íŒ¨: ' + e.message + '</span>';
            }
        }
    </script>
</body>
</html>
